<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tap Master Pro</title>

    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tap Master">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyNpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ4IDc5LjE2NDAzNiwgMjAxOS8wOC8xMy0wMTowNjo1NyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDIxLjAgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjY5NjdEOTM1QTY4MTExRUE5QjlGRTg2NzAwMDAwMDAwIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjY5NjdEOTM2QTY4MTExRUE5QjlGRTg2NzAwMDAwMDAwIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6Njk2N0Q5MzNBNjgxMTFFQTlCOUZFODY3MDAwMDAwMDAiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6Njk2N0Q5MzRBNjgxMTFFQTlCOUZFODY3MDAwMDAwMDAiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4=">
</head>
<body>
    <div id="gameContainer">
        <!-- Main Menu Screen -->
        <div id="mainMenuScreen" class="screen active">
            <div class="container">
                <h1 class="game-title">Tap Master Pro</h1>
                <button class="menu-button" onclick="showLevelSelection()">Play Game</button>
                <button class="menu-button" onclick="showTutorial()">How to Play</button>
                <button class="menu-button" onclick="showHighScores()">High Scores</button>
            </div>
        </div>

        <!-- Level Selection Screen -->
        <div id="levelSelectionScreen" class="screen">
            <div class="container">
                <h2 class="game-title">Select Level</h2>
                <div class="level-grid" id="levelGrid"></div>
                <button class="menu-button" onclick="showMainMenu()">Back</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <div class="hud">
                <div class="hud-item">
                    <div class="hud-label">SCORE</div>
                    <div class="hud-value" id="score">0</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">LEVEL</div>
                    <div class="hud-value" id="level">1</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">TIME</div>
                    <div class="hud-value" id="timer">30</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">GOAL</div>
                    <div class="hud-value" id="goal">0/10</div>
                </div>
            </div>
            <div class="goal-progress">
                <div class="goal-bar" id="goalBar"></div>
            </div>
            <div id="playArea"></div>
        </div>

        <!-- Level Complete Screen -->
        <div id="levelCompleteScreen" class="screen">
            <div class="container">
                <h2 class="game-title">Level Complete!</h2>
                <div class="score-display">Score: <span id="levelScore">0</span></div>
                <div class="goal-display">Goal Reached: <span id="goalReached">0/0</span></div>
                <button class="menu-button" onclick="nextLevel()">Next Level</button>
                <button class="menu-button" onclick="retryLevel()">Retry Level</button>
                <button class="menu-button" onclick="showLevelSelection()">Level Select</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="screen">
            <div class="container">
                <h2 class="game-title">Game Over!</h2>
                <div class="score-display">Final Score: <span id="finalScore">0</span></div>
                <button class="menu-button" onclick="retryLevel()">Try Again</button>
                <button class="menu-button" onclick="showLevelSelection()">Level Select</button>
                <button class="menu-button" onclick="showMainMenu()">Main Menu</button>
            </div>
        </div>

        <!-- Tutorial Screen -->
        <div id="tutorialScreen" class="screen">
            <div class="container">
                <h2 class="game-title">How to Play</h2>
                <div style="text-align: left; margin: 20px 0;">
                    <p>ðŸŸ¢ Green Balls: +1 Point</p>
                    <p>ðŸ”µ Blue Balls: +5 Seconds</p>
                    <p>ðŸŸ¡ Yellow Balls: -3 Seconds</p>
                    <p>ðŸ”´ Red Balls: Game Over!</p>
                    <p style="margin-top: 20px;">Complete the goal to advance to the next level!</p>
                </div>
                <button class="menu-button" onclick="showMainMenu()">Got it!</button>
            </div>
        </div>
    </div>
</body>
</html>

<style>
    /* iOS Base Optimizations */
    * {
        box-sizing: border-box;
        user-select: none;
        -webkit-user-select: none;
        -webkit-tap-highlight-color: transparent;
        margin: 0;
        padding: 0;
        font-family: -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    html, body {
        position: fixed;
        overflow: hidden;
        width: 100%;
        height: 100%;
        overscroll-behavior: none;
    }

    @supports (padding: max(0px)) {
        body {
            padding-top: max(env(safe-area-inset-top), 20px);
            padding-bottom: max(env(safe-area-inset-bottom), 20px);
        }
    }

    /* Base Styles and Background */
    body {
        margin: 0;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
        background: linear-gradient(-45deg, #0f2027, #203a43, #2c5364);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
        position: fixed;
        touch-action: manipulation;
    }

    #gameContainer {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    /* Animations */
    @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulseBall {
        from { transform: scale(1); }
        to { transform: scale(1.1); }
    }

    @keyframes dangerPulse {
        0% { opacity: 0.2; }
        50% { opacity: 1; }
        100% { opacity: 0.2; }
    }

    @keyframes floatUp {
        0% { transform: translateY(0); opacity: 1; }
        100% { transform: translateY(-50px); opacity: 0; }
    }

    /* Screen Styles */
    .screen {
        position: absolute;
        width: 100%;
        height: 100%;
        display: none;
        justify-content: center;
        align-items: center;
        color: white;
        transition: opacity 0.3s ease;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }

    .screen.active {
        display: flex;
    }

    /* Container and UI Elements */
    .container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        border: 1px solid rgba(255, 255, 255, 0.18);
        animation: fadeIn 0.5s ease-out;
    }

    .game-title {
        font-size: 2.8em;
        margin-bottom: 20px;
        background: linear-gradient(45deg, #FFD700, #FFA500);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        font-weight: bold;
    }

    /* Buttons */
    .menu-button {
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        border: none;
        border-radius: 10px;
        background: linear-gradient(45deg, #FFD700, #FFA500);
        color: #1a1a1a;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .menu-button:active {
        transform: scale(0.95);
        opacity: 0.8;
    }

    /* Level Grid */
    .level-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin: 20px 0;
        max-height: 60vh;
        overflow-y: auto;
        padding: 10px;
        -webkit-overflow-scrolling: touch;
    }

    .level-button {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 10px;
        padding: 15px;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .level-button.unlocked {
        background: linear-gradient(45deg, #4CAF50, #45a049);
    }

    .level-button.current {
        background: linear-gradient(45deg, #FFD700, #FFA500);
        color: #1a1a1a;
    }

    .level-button.locked {
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.3);
        pointer-events: none;
    }

    /* HUD */
    .hud {
        position: fixed;
        top: env(safe-area-inset-top, 0px);
        left: 0;
        right: 0;
        height: 70px;
        padding: 10px 20px;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .hud-item {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .hud-label {
        font-size: 14px;
        color: #FFD700;
        margin-bottom: 5px;
    }

    .hud-value {
        font-size: 24px;
        font-weight: bold;
        color: white;
    }

    /* Progress Bar */
    .goal-progress {
        position: fixed;
        top: calc(70px + env(safe-area-inset-top, 0px));
        left: 0;
        right: 0;
        height: 10px;
        background: rgba(255, 255, 255, 0.1);
        z-index: 1000;
    }

    .goal-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #FFD700, #FFA500);
        transition: width 0.3s ease;
    }

    /* Play Area */
    #playArea {
        position: absolute;
        top: calc(80px + env(safe-area-inset-top, 0px));
        left: 10px;
        right: 10px;
        bottom: calc(10px + env(safe-area-inset-bottom, 0px));
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        touch-action: none;
    }

    /* Ball Styles */
    .ball {
        position: absolute;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        cursor: pointer;
        transform-origin: center;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        color: white;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        transition: transform 0.1s ease;
        will-change: transform;
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
    }

    .ball:active {
        transform: scale(0.9);
    }

    .ball.normal {
        background: radial-gradient(circle at 30% 30%, #4CAF50, #228B22);
        box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
        animation: pulseBall 1.5s infinite alternate;
    }

    .ball.timeBonus {
        background: radial-gradient(circle at 30% 30%, #2196F3, #0D47A1);
        box-shadow: 0 0 20px rgba(33, 150, 243, 0.6);
        animation: pulseBall 1.5s infinite alternate;
    }

    .ball.timePenalty {
        background: radial-gradient(circle at 30% 30%, #FFC107, #FF8F00);
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
        animation: pulseBall 1.5s infinite alternate;
    }

    .ball.danger {
        background: radial-gradient(circle at 30% 30%, #f44336, #d32f2f);
        box-shadow: 0 0 20px rgba(244, 67, 54, 0.6);
        animation: dangerPulse 2s infinite;
    }

    /* Popup Styles */
    .popup {
        position: absolute;
        pointer-events: none;
        animation: floatUp 1s ease-out forwards;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        z-index: 1001;
        font-size: 24px;
    }

    .popup.score { color: #4CAF50; }
    .popup.time-bonus { color: #2196F3; }
    .popup.time-penalty { color: #FFC107; }
    .popup.danger { color: #f44336; }

    /* Score Display */
    .score-display, .goal-display {
        font-size: 24px;
        color: #FFD700;
        margin: 10px 0;
    }
</style>

<script>
    // Game Configuration
    const LEVEL_CONFIG = {
        getLevelGoal: (level) => Math.min(10 + Math.floor(level * 1.5), 30),
        getTimeLimit: (level) => Math.max(30 - Math.floor(level * 0.5), 15),
        getBallSpeed: (level) => Math.min(3 + level * 0.8, 12),
        getBallCount: (level) => Math.min(3 + Math.floor(level / 2), 8),
        getDangerBallInterval: (level) => Math.max(5000 - (level * 300), 2000)
    };
    
    // Game State Management
    const gameState = {
        level: 1,
        score: 0,
        timeLeft: 30,
        isPlaying: false,
        balls: [],
        gameInterval: null,
        dangerInterval: null,
        highScores: {},
        unlockedLevels: 1,
        maxLevels: 30,
        currentGoal: 10,
        goalProgress: 0
    };
    
    // Sound Effects (minimal audio for iOS compatibility)
    const sounds = {
        pop: new Audio('data:audio/wav;base64,UklGRn4AAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YVoAAAAAAA=='),
        bonus: new Audio('data:audio/wav;base64,UklGRn4AAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YVoAAAAAAA=='),
        penalty: new Audio('data:audio/wav;base64,UklGRn4AAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YVoAAAAAAA=='),
        gameOver: new Audio('data:audio/wav;base64,UklGRn4AAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YVoAAAAAAA==')
    };
    
    // Screen Management
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
    }
    
    // Navigation Functions
    function showMainMenu() {
        clearInterval(gameState.gameInterval);
        clearInterval(gameState.dangerInterval);
        showScreen('mainMenuScreen');
    }
    
    function showLevelSelection() {
        const levelGrid = document.getElementById('levelGrid');
        levelGrid.innerHTML = '';
        
        for (let i = 1; i <= gameState.maxLevels; i++) {
            const button = document.createElement('button');
            button.className = `level-button ${i <= gameState.unlockedLevels ? 'unlocked' : 'locked'}`;
            if (i === gameState.unlockedLevels) button.className += ' current';
            button.textContent = i;
            
            if (i <= gameState.unlockedLevels) {
                button.onclick = () => startGame(i);
            }
            
            levelGrid.appendChild(button);
        }
        
        showScreen('levelSelectionScreen');
    }
    
    function showTutorial() {
        showScreen('tutorialScreen');
    }
    
    function showHighScores() {
        alert('High Scores coming soon!');
    }
    
    // Timer Management
    function startTimer() {
        if (gameState.gameInterval) {
            clearInterval(gameState.gameInterval);
        }
    
        const timerDisplay = document.getElementById('timer');
        gameState.gameInterval = setInterval(() => {
            gameState.timeLeft--;
            timerDisplay.textContent = gameState.timeLeft;
            
            if (gameState.timeLeft <= 0) {
                gameOver();
            }
        }, 1000);
    }
    
    // Progress Updates
    function updateGoalProgress() {
        document.getElementById('goal').textContent = 
            `${gameState.goalProgress}/${gameState.currentGoal}`;
        document.getElementById('goalBar').style.width = 
            `${(gameState.goalProgress / gameState.currentGoal) * 100}%`;
        document.getElementById('score').textContent = gameState.score;
    }
    
    // Game Over Management
    function gameOver() {
        sounds.gameOver.play();
        clearInterval(gameState.gameInterval);
        clearInterval(gameState.dangerInterval);
        gameState.isPlaying = false;
    
        document.getElementById('finalScore').textContent = gameState.score;
        showScreen('gameOverScreen');
    
        // Update high scores
        if (!gameState.highScores[gameState.level] || 
            gameState.score > gameState.highScores[gameState.level]) {
            gameState.highScores[gameState.level] = gameState.score;
            localStorage.setItem('tapMasterHighScores', JSON.stringify(gameState.highScores));
        }
    }
    
    // Level Management
    function retryLevel() {
        startGame(gameState.level);
    }
    
    function nextLevel() {
        if (gameState.level < gameState.maxLevels) {
            startGame(gameState.level + 1);
        } else {
            showLevelSelection();
        }
    }
    
    // Level Completion
    function levelComplete() {
        clearInterval(gameState.gameInterval);
        clearInterval(gameState.dangerInterval);
        gameState.isPlaying = false;
        
        if (gameState.level >= gameState.unlockedLevels) {
            gameState.unlockedLevels = Math.min(gameState.level + 1, gameState.maxLevels);
            localStorage.setItem('tapMasterUnlockedLevels', gameState.unlockedLevels);
        }
    
        document.getElementById('levelScore').textContent = gameState.score;
        document.getElementById('goalReached').textContent = 
            `${gameState.goalProgress}/${gameState.currentGoal}`;
        
        showScreen('levelCompleteScreen');
    }
    
    // Game Initialization
    function initGame() {
        // Load saved data
        const savedHighScores = localStorage.getItem('tapMasterHighScores');
        const savedUnlockedLevels = localStorage.getItem('tapMasterUnlockedLevels');
        
        if (savedHighScores) {
            gameState.highScores = JSON.parse(savedHighScores);
        }
        if (savedUnlockedLevels) {
            gameState.unlockedLevels = parseInt(savedUnlockedLevels);
        }
    
        // iOS-specific event handling
        document.addEventListener('touchstart', function(event) {
            if (event.target.classList.contains('ball')) {
                event.preventDefault();
            }
        }, { passive: false });
    
        document.body.addEventListener('touchmove', function(event) {
            event.preventDefault();
        }, { passive: false });
    
        showMainMenu();
    }
    
    // Initialize when document is ready
    window.onload = initGame;
    </script>

<script>
    // Ball Creation and Management
    function createBall(type = 'normal') {
        if (!gameState.isPlaying) return null;
    
        const ball = document.createElement('div');
        const playArea = document.getElementById('playArea');
        const rect = playArea.getBoundingClientRect();
        const size = 60;
    
        ball.className = `ball ${type}`;
        
        // Configure ball appearance and text based on type
        switch(type) {
            case 'timeBonus':
                ball.innerHTML = '<span>+5s</span>';
                ball.style.background = 'radial-gradient(circle at 30% 30%, #2196F3, #0D47A1)';
                break;
            case 'timePenalty':
                ball.innerHTML = '<span>-3s</span>';
                ball.style.background = 'radial-gradient(circle at 30% 30%, #FFC107, #FF8F00)';
                break;
            case 'danger':
                ball.innerHTML = '<span>âœ•</span>';
                ball.style.background = 'radial-gradient(circle at 30% 30%, #f44336, #d32f2f)';
                break;
            default:
                ball.innerHTML = '<span>+1</span>';
                ball.style.background = 'radial-gradient(circle at 30% 30%, #4CAF50, #228B22)';
        }
    
        // Position ball with padding to avoid edge spawning
        const maxX = rect.width - size;
        const maxY = rect.height - size;
        const padding = 20;
    
        let x = Math.random() * (maxX - 2 * padding) + padding;
        let y = Math.random() * (maxY - 2 * padding) + padding;
    
        ball.style.left = `${x}px`;
        ball.style.top = `${y}px`;
        ball.dataset.type = type;
    
        // Add event listeners for both touch and click
        ball.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handleBallClick(ball);
        }, { passive: false });
        
        ball.addEventListener('click', () => handleBallClick(ball));
        
        playArea.appendChild(ball);
        gameState.balls.push(ball);
    
        // Remove danger balls after delay
        if (type === 'danger') {
            setTimeout(() => {
                if (ball && ball.parentElement) {
                    ball.remove();
                    gameState.balls = gameState.balls.filter(b => b !== ball);
                }
            }, 2000);
        }
    
        moveBall(ball);
        return ball;
    }
    
    // Ball Movement Animation
    function moveBall(ball) {
        const speed = LEVEL_CONFIG.getBallSpeed(gameState.level);
        let dx = (Math.random() - 0.5) * speed;
        let dy = (Math.random() - 0.5) * speed;
    
        function animate() {
            if (!gameState.isPlaying || !ball.parentElement) return;
    
            const playArea = document.getElementById('playArea');
            const rect = playArea.getBoundingClientRect();
            const ballRect = ball.getBoundingClientRect();
    
            let x = ballRect.left - rect.left + dx;
            let y = ballRect.top - rect.top + dy;
    
            // Bounce off walls
            if (x <= 0 || x >= rect.width - ballRect.width) {
                dx = -dx;
                x = Math.max(0, Math.min(x, rect.width - ballRect.width));
            }
            if (y <= 0 || y >= rect.height - ballRect.height) {
                dy = -dy;
                y = Math.max(0, Math.min(y, rect.height - ballRect.height));
            }
    
            ball.style.left = `${x}px`;
            ball.style.top = `${y}px`;
    
            requestAnimationFrame(animate);
        }
    
        animate();
    }
    
    // Ball Click Handler
    function handleBallClick(ball) {
        if (!gameState.isPlaying) return;
    
        const type = ball.dataset.type;
        const rect = ball.getBoundingClientRect();
    
        switch(type) {
            case 'normal':
                gameState.score++;
                gameState.goalProgress++;
                updateGoalProgress();
                showPopup('+1', rect, 'score');
                sounds.pop.play();
                break;
            case 'timeBonus':
                gameState.timeLeft = Math.min(gameState.timeLeft + 5, LEVEL_CONFIG.getTimeLimit(gameState.level));
                showPopup('+5s', rect, 'time-bonus');
                sounds.bonus.play();
                break;
            case 'timePenalty':
                gameState.timeLeft = Math.max(gameState.timeLeft - 3, 0);
                showPopup('-3s', rect, 'time-penalty');
                sounds.penalty.play();
                break;
            case 'danger':
                gameOver();
                return;
        }
    
        // Remove clicked ball
        ball.remove();
        gameState.balls = gameState.balls.filter(b => b !== ball);
    
        // Create new ball with random type
        const randomValue = Math.random();
        let newType = 'normal';
    
        if (randomValue > 0.7) {
            newType = Math.random() > 0.5 ? 'timeBonus' : 'timePenalty';
        }
    
        createBall(newType);
        ensureMinimumBalls();
    
        // Check level completion
        if (gameState.goalProgress >= gameState.currentGoal) {
            levelComplete();
        }
    }
    
    // Score Popup Animation
    function showPopup(text, rect, type) {
        const popup = document.createElement('div');
        popup.className = `popup ${type}`;
        popup.textContent = text;
        popup.style.left = `${rect.left}px`;
        popup.style.top = `${rect.top}px`;
        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), 1000);
    }
    
    // Ensure Minimum Number of Normal Balls
    function ensureMinimumBalls() {
        const normalBalls = gameState.balls.filter(ball => ball.dataset.type === 'normal');
        if (normalBalls.length === 0) {
            createBall('normal');
        }
    }
    
    // Start Game Setup
    function startGame(level) {
        // Initialize game state
        gameState.level = level;
        gameState.score = 0;
        gameState.timeLeft = LEVEL_CONFIG.getTimeLimit(level);
        gameState.isPlaying = true;
        gameState.balls = [];
        gameState.currentGoal = LEVEL_CONFIG.getLevelGoal(level);
        gameState.goalProgress = 0;
    
        // Update display
        document.getElementById('score').textContent = '0';
        document.getElementById('level').textContent = level;
        document.getElementById('timer').textContent = gameState.timeLeft;
        updateGoalProgress();
    
        // Clear existing balls
        const playArea = document.getElementById('playArea');
        playArea.innerHTML = '';
    
        // Create initial balls
        for (let i = 0; i < LEVEL_CONFIG.getBallCount(level); i++) {
            createBall('normal');
        }
    
        // Start danger ball spawning for levels > 1
        if (level > 1) {
            gameState.dangerInterval = setInterval(() => {
                if (Math.random() < 0.7) { // 70% chance to spawn danger ball
                    createBall('danger');
                }
            }, LEVEL_CONFIG.getDangerBallInterval(level));
        }
    
        startTimer();
        showScreen('gameScreen');
    }
    </script>